# Go2 机器人 WebRTC 代理架构

## 架构概述

新的架构将 `webrtc_proxy` 实现为一个 WebRTC 客户端，可以接收机器人的视频流并通过 WebRTC 转发给多个前端应用。这种设计具有以下优势：

### 🎯 **主要优势**

1. **多客户端支持** - 多个前端应用可以同时连接到同一个机器人
2. **减少网络负载** - 视频流只需要从机器人传输到代理一次
3. **更好的扩展性** - 可以轻松添加更多客户端
4. **实时性更好** - WebRTC 提供更低的延迟
5. **浏览器兼容性** - 利用浏览器原生的 WebRTC 支持

## 架构图

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   机器人 Go2    │────│  WebRTC 代理     │────│   前端应用 1    │
│                │    │                │    │                │
│  - 视频流      │    │  - 机器人连接    │    │  - WebRTC 客户端│
│  - 控制命令    │    │  - WebRTC 服务器 │    │  - 视频显示     │
└─────────────────┘    │  - 多客户端管理  │    └─────────────────┘
                       └──────────────────┘
                                │
                                │
                       ┌─────────────────┐
                       │   前端应用 2    │
                       │                │
                       │  - WebRTC 客户端│
                       │  - 视频显示     │
                       └─────────────────┘
```

## 核心组件

### 1. **WebRTCProxy** - 代理服务器
- 管理机器人连接
- 创建和管理 WebRTC 客户端
- 广播视频流给所有连接的客户端
- 处理控制命令

### 2. **WebRTCClient** - WebRTC 客户端
- 为每个前端应用创建独立的 WebRTC 连接
- 管理视频和音频轨道
- 处理 SDP 协商

### 3. **前端应用** - WebRTC 客户端
- 通过 WebRTC 连接到代理
- 接收和显示视频流
- 发送控制命令

## API 接口

### 机器人连接
```http
POST /api/connect
{
  "robot_ip": "192.168.1.100",
  "token": "your_token"
}
```

### WebRTC 客户端连接
```http
GET /webrtc/client?robot_ip=192.168.1.100&token=your_token
```

### WebRTC 应答
```http
POST /webrtc/answer
{
  "client_id": "client_123",
  "answer": {
    "type": "answer",
    "sdp": "..."
  }
}
```

### 控制命令
```http
POST /api/command
{
  "robot_ip": "192.168.1.100",
  "token": "your_token",
  "command": "Hello"
}
```

### 视频控制
```http
POST /api/video
{
  "robot_ip": "192.168.1.100",
  "token": "your_token",
  "command": "open"
}
```

## 使用方式

### 1. 启动代理服务器
```bash
cd go_proj
go run .
```

### 2. 访问 WebRTC 客户端
```
http://localhost:8080/webrtc_client.html
```

### 3. 连接机器人
- 输入机器人 IP 地址和访问令牌
- 点击"连接机器人"
- 系统会自动建立 WebRTC 连接

### 4. 控制机器人
- 使用命令下拉菜单或快速命令按钮
- 开启/关闭视频流
- 实时查看视频

## 多客户端支持

多个浏览器窗口或设备可以同时连接到同一个机器人：

1. **共享连接** - 所有客户端共享同一个机器人连接
2. **独立视频流** - 每个客户端获得独立的 WebRTC 视频流
3. **实时同步** - 所有客户端看到相同的实时视频
4. **独立控制** - 每个客户端都可以发送控制命令

## 技术细节

### 视频流处理
1. 机器人发送 RTP 视频包到代理
2. 代理解析 RTP 信息并保留完整数据
3. 代理将视频数据转发给所有连接的 WebRTC 客户端
4. 前端通过 WebRTC 接收并显示视频

### 连接管理
- 每个机器人连接有唯一的连接 ID
- 每个 WebRTC 客户端有唯一的客户端 ID
- 代理维护连接映射关系
- 自动清理断开的连接

### 错误处理
- 网络断开自动重连
- WebRTC 连接失败时的降级处理
- 详细的错误日志和用户提示

## 性能优化

### 1. **视频编码**
- 支持 H.264 和 VP8 编码
- 自动检测编码格式
- 优化视频质量

### 2. **网络优化**
- 使用 STUN 服务器进行 NAT 穿透
- ICE 候选地址优化
- 连接状态监控

### 3. **资源管理**
- 自动清理断开的连接
- 内存使用优化
- 视频缓冲区管理

## 安全考虑

### 1. **访问控制**
- 基于令牌的身份验证
- 连接权限验证
- 命令权限检查

### 2. **网络安全**
- WebRTC 加密传输
- HTTPS 支持
- 输入验证和清理

## 扩展性

### 1. **水平扩展**
- 可以部署多个代理实例
- 负载均衡支持
- 集群管理

### 2. **功能扩展**
- 支持音频流
- 录制功能
- 截图功能
- 视频分析

### 3. **协议扩展**
- 支持更多机器人型号
- 自定义命令协议
- 插件系统

## 故障排除

### 常见问题

1. **连接失败**
   - 检查机器人 IP 和令牌
   - 确认网络连接
   - 查看服务器日志

2. **视频不显示**
   - 检查浏览器 WebRTC 支持
   - 确认视频流已开启
   - 查看控制台错误

3. **延迟过高**
   - 检查网络质量
   - 优化视频编码参数
   - 考虑使用更近的 STUN 服务器

### 调试工具
- 浏览器开发者工具
- 服务器日志
- WebRTC 统计信息
- 网络分析工具

## 总结

新的 WebRTC 代理架构提供了更好的多客户端支持、更低的延迟和更好的扩展性。通过将代理作为 WebRTC 服务器，前端应用可以直接通过 WebRTC 接收视频流，实现了更高效的视频传输和更好的用户体验。 